<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¼æ¥­ç®¡ç†ç³»çµ±ç°¡ä»‹èˆ‡ç¤ºç¯„ â€” MRP / ERP / SCM / CRM</title>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

  /* ç¶²å€åˆ—æ¨£å¼ */
    nav {
      background-color: #FFF6F3;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 999;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 700;
    }
    nav a:hover {
      text-decoration: underline;
    }

  :root{
    --bg:#FFF8F2;
    --card:#FFF6F3;
    --accent:#E07A5F; /* warm coral */
    --accent-2:#F5A882; /* softer */
    --muted:#8B6A5A;
    --text:#3B2B2A;
    --soft:#FBDCCB;
    --glass: rgba(255,255,255,0.6);
    font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
  }
  body{
    margin:0;
    background: linear-gradient(180deg, var(--bg), #FFF4EE);
    color:var(--text);
  }
  /* å›ºå®šé ‚éƒ¨å°è¦½ */
  header{
    position:fixed; top:0; left:0; right:0;
    height:64px; display:flex; align-items:center;
    padding:0 20px; box-sizing:border-box;
    background: linear-gradient(90deg, rgba(224,122,95,0.96), rgba(245,168,130,0.92));
    color:white; z-index:40; box-shadow:0 2px 8px rgba(0,0,0,0.08);
  }
  header h1{ margin:0; font-size:18px; letter-spacing:0.6px; }
  .container{
    display:flex; gap:20px;
    padding:88px 20px 40px 20px;
    box-sizing:border-box;
  }
  /* å´é‚Šé¸å–® */
  nav.sidebar{
    width:260px; background:var(--card); border-radius:12px;
    padding:16px; box-shadow:0 6px 18px rgba(224,122,95,0.06);
    height:calc(100vh - 120px); overflow:auto;
    position:sticky; top:80px;
  }
  .nav-item{ padding:10px 12px; border-radius:8px; margin-bottom:8px; cursor:pointer; color:var(--muted); display:flex; align-items:center; gap:10px; }
  .nav-item.active{ background:linear-gradient(90deg,var(--soft),#FFEDE5); color:var(--accent-2); font-weight:600; box-shadow: inset 0 0 0 1px rgba(224,122,95,0.06);}
  .nav-item:hover{ background:#FFF1EC; color:var(--accent-2); }
  main.content{
    flex:1; display:flex; flex-direction:column; gap:18px;
  }
  .card{ background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.04); }
  .flex-row{ display:flex; gap:12px; align-items:center; }
  .space{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
  th,td{ padding:10px 8px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
  th{ color:var(--muted); font-weight:700; font-size:13px; }
  button{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn-primary{ background:var(--accent); color:white; box-shadow: 0 4px 12px rgba(224,122,95,0.12); }
  .btn-ghost{ background:transparent; color:var(--accent); border:1px solid rgba(224,122,95,0.12); }
  .icon-btn{ background:transparent; padding:6px 8px; border-radius:8px; color:var(--muted); }
  .small{ padding:6px 8px; border-radius:6px; font-weight:600; }
  .muted{ color:var(--muted); font-size:13px; }
  /* è¡¨å–® */
  .form-row{ display:flex; gap:8px; margin-top:8px; }
  .form-row input, .form-row select, textarea{ padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; flex:1; }
  .right-panel{ width:320px; display:flex; flex-direction:column; gap:12px; position:sticky; top:80px; height:calc(100vh - 120px); }
  /* footer */
  footer{ padding:12px; text-align:center; color:var(--muted); font-size:13px; margin-top:8px; }
  @media(max-width:980px){
    .container{ flex-direction:column; padding:110px 12px 30px 12px; }
    nav.sidebar{ width:100%; height:auto; position:relative; top:auto; display:flex; overflow-x:auto; }
    .right-panel{ position:relative; width:100%; }
  }
</style>
</head>
<body>
<header>
  <h1>ä¼æ¥­ç®¡ç†ç³»çµ±ç¤ºç¯„ (MRP / MRP II / ERP / SCM / CRM / EERP)</h1>

<!-- ç¶²å€åˆ— -->

    <a href="sys.html">ğŸ  å›é¦–é ï¼ˆè³‡è¨Šç³»çµ±ï¼‰</a>
    <a href="resume.html">ã€‚  å±¥æ­·</a>

</header>

<div class="container">
  <nav class="sidebar card" id="menu">
    <!-- menu items injected by JS -->
  </nav>

  <main class="content">
    <section class="card" id="overview">
      <div class="space">
        <div>
          <h2 id="systemTitle" style="margin:0">MRP â€” ç‰©æ–™éœ€æ±‚è¦åŠƒï¼ˆç¤ºç¯„ï¼‰</h2>
          <div class="muted" id="systemSubtitle">ç”Ÿç”¢æ’ç¨‹èˆ‡é›¶ä»¶å‚™æ–™ç®¡ç†</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn-primary" id="addBtn">æ–°å¢ç­†éŒ„</button>
          <button class="btn-ghost" id="resetBtn" title="é‡ç½®ç¯„ä¾‹è³‡æ–™">é‚„åŸç¯„ä¾‹</button>
        </div>
      </div>

      <p id="systemDesc" style="margin-top:12px; line-height:1.6;">
        <!-- description injected -->
      </p>
    </section>

    <section class="card" id="dataSection">
      <div class="space">
        <div><strong>è³‡æ–™åˆ—è¡¨</strong> <span class="muted" id="listCount"></span></div>
        <div class="muted">æ“ä½œï¼šæ–°å¢ / ç·¨è¼¯ / åˆªé™¤ï¼ˆè³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿï¼‰</div>
      </div>

      <table id="dataTable" aria-label="è³‡æ–™è¡¨">
        <thead>
          <tr><th>é …ç›®</th><th>æè¿°</th><th>æ•¸é‡</th><th>æˆæœ¬</th><th style="width:140px;">æ“ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" id="notes">
      <div class="space">
        <div><strong>ç³»çµ±æ¨¡çµ„ç¸½è¦½ï¼ˆç°¡åŒ–ç‰ˆï¼‰</strong></div>
        <div class="muted">MRP / MRP II / ERP / SCM / CRM / EERP</div>
      </div>
      <div style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;">
        <!-- quick cards -->
        <div style="background:linear-gradient(180deg,#FFF5F2, #FFF2F0); padding:12px; border-radius:10px;">
          <strong>MRP</strong>
          <div class="muted" style="margin-top:6px;">ç‰©æ–™éœ€æ±‚è¨ˆç®—ã€BOMã€æ’ç¨‹ã€é ˜æ–™èˆ‡æ¡è³¼è§¸ç™¼ã€‚</div>
        </div>
        <div style="background:linear-gradient(180deg,#FFF8ED,#FFF4EE); padding:12px; border-radius:10px;">
          <strong>MRP II</strong>
          <div class="muted" style="margin-top:6px;">æ“´å…… MRPï¼ŒåŠ å…¥æœƒè¨ˆèˆ‡éŠ·å”®ç­‰è£½é€ è³‡æºè¦åŠƒæ¨¡çµ„ã€‚</div>
        </div>
        <div style="background:linear-gradient(180deg,#FFF6F3,#FFF1EE); padding:12px; border-radius:10px;">
          <strong>ERP</strong>
          <div class="muted" style="margin-top:6px;">ä¼æ¥­è³‡æºæ•´åˆç³»çµ±ï¼šæ¶µè“‹è²¡å‹™ã€äººè³‡ã€æ¡è³¼ã€ç”Ÿç”¢ç­‰ã€‚</div>
        </div>
        <div style="background:linear-gradient(180deg,#FFF8F4,#FFF3F0); padding:12px; border-radius:10px;">
          <strong>SCM</strong>
          <div class="muted" style="margin-top:6px;">ä¾›æ‡‰å•†é€£çµã€æ¡è³¼éœ€æ±‚ã€å ±åƒ¹ç¢ºèªã€çµç®—èˆ‡ç™¼ç¥¨æµç¨‹ã€‚</div>
        </div>
        <div style="background:linear-gradient(180deg,#FFF7F3,#FFF1EF); padding:12px; border-radius:10px;">
          <strong>CRM</strong>
          <div class="muted" style="margin-top:6px;">ç®¡ç†é¡§å®¢äº’å‹•ã€åˆ†ç¾¤ï¼ˆRFMï¼‰ã€æå‡é¡§å®¢çµ‚èº«åƒ¹å€¼ (LTV)ã€‚</div>
        </div>
        <div style="background:linear-gradient(180deg,#FFF5F2,#FFF0EE); padding:12px; border-radius:10px;">
          <strong>EERP</strong>
          <div class="muted" style="margin-top:6px;">æ“´å……å‹ ERPï¼šæ•´åˆ SCMã€ERPã€CRM æˆç‚ºè·¨çµ„ç¹”å¹³å°ã€‚</div>
        </div>
      </div>
    </section>

  </main>

  <aside class="right-panel">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>åœ“é¤…å„€è¡¨æ¿</strong>
        <div class="muted" style="font-size:13px;">ç³»çµ±è³‡æ–™åˆ†ä½ˆ</div>
      </div>
      <canvas id="pieChart" style="margin-top:8px; width:100%; height:220px;"></canvas>
      <div class="muted" style="margin-top:8px;">é¡è‰²ç‚ºæš–è‰²ç³»ï¼Œé¡¯ç¤ºæ¯å€‹ç³»çµ±çš„ç­†æ•¸æ¯”ä¾‹ã€‚</div>
    </div>

    <div class="card">
      <strong>å¿«é€Ÿæ“ä½œ</strong>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="small btn-primary" id="exportBtn">åŒ¯å‡º JSON</button>
        <button class="small btn-ghost" id="importBtn">åŒ¯å…¥ JSON</button>
      </div>
      <div class="muted" style="margin-top:8px;">åŒ¯å‡ºæœƒä¸‹è¼‰ç›®å‰ localStorage çš„è³‡æ–™ã€‚åŒ¯å…¥æœƒè¦†è“‹æœ¬æ©Ÿè³‡æ–™ã€‚</div>
    </div>

    <div class="card" style="text-align:center;">
      <div class="muted">ç¤ºç¯„ç³»çµ± â€¢ æœ¬æ©Ÿæ¸¬è©¦ç‰ˆ</div>
      <div style="margin-top:8px; font-size:13px; color:var(--muted)">è³‡æ–™ä¸æœƒé€å‡ºåˆ°å¤–ç¶²</div>
    </div>
  </aside>
</div>

<footer>
  è‹¥éœ€è¦æˆ‘æŠŠé…è‰²æˆ–æ¬„ä½ï¼ˆä¾‹å¦‚æ–°å¢ BOM æ¬„ä½ã€æˆæœ¬è¨ˆç®—ç¯„ä¾‹ï¼‰æ›´ç´°ç·»åŒ–ï¼Œå¯ç›´æ¥å‘Šè¨´æˆ‘æƒ³è¦çš„æ¬„ä½èˆ‡è¦å‰‡ã€‚
</footer>

<!-- ç·¨è¼¯ / æ–°å¢å°è©±æ¡† (ç°¡å–®å¯¦ä½œ) -->
<div id="modalRoot" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:60;">
  <div style="position:absolute; inset:0; background:rgba(0,0,0,0.2)"></div>
  <div style="width:720px; max-width:95%; background:white; border-radius:12px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,0.2); position:relative;">
    <h3 id="modalTitle" style="margin:0 0 8px 0">æ–°å¢ç­†éŒ„</h3>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div style="flex:1">
        <label class="muted">é …ç›®åç¨±</label>
        <input id="f_name" placeholder="ä¾‹å¦‚ï¼šCPU" />
      </div>
      <div style="width:160px">
        <label class="muted">æ•¸é‡</label>
        <input id="f_qty" type="number" min="0" />
      </div>
      <div style="width:160px">
        <label class="muted">æˆæœ¬ï¼ˆæ¯ä»¶ï¼‰</label>
        <input id="f_cost" type="number" min="0" />
      </div>
      <div style="flex-basis:100%;"></div>
      <div style="flex:1">
        <label class="muted">æè¿°</label>
        <input id="f_desc" placeholder="ç°¡çŸ­æè¿°æˆ–å‚™è¨»" />
      </div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button class="icon-btn" id="cancelModal">å–æ¶ˆ</button>
      <button class="btn-primary" id="saveModal">å„²å­˜</button>
    </div>
  </div>
</div>

<script>
/* --- å¸¸æ•¸èˆ‡ç¯„ä¾‹è³‡æ–™ --- */
const systems = [
  {key:'mrp', title:'MRP', subtitle:'ç‰©æ–™éœ€æ±‚è¦åŠƒ', desc:`æ”¯æ´ç”Ÿç”¢æ’ç¨‹èˆ‡ç‰©æ–™å‚™æ–™ã€‚æ ¹æ“š BOMï¼ˆç‰©æ–™è¡¨ï¼‰èˆ‡è¨‚å–®æ•¸é‡ï¼Œè¨ˆç®—å„é›¶ä»¶æ‰€éœ€æ•¸é‡ï¼Œè‹¥åº«å­˜ä½æ–¼å®‰å…¨åº«å­˜å‰‡è§¸ç™¼æ¡è³¼æˆ–é ˜æ–™ã€‚ä¸»è¦è¼¸å‡ºï¼šé ˜æ–™å–®ã€æ¡è³¼å–®ã€ç‰©æ–™æˆæœ¬ã€‚`},
  {key:'mrpii', title:'MRP II', subtitle:'è£½é€ è³‡æºè¦åŠƒï¼ˆæ“´å……ï¼‰', desc:`åœ¨ MRP åŸºç¤ä¸Šï¼ŒåŠ å…¥æ›´å¤šè£½é€ è³‡æºç®¡ç†æ¨¡çµ„ï¼Œä¾‹å¦‚æœƒè¨ˆã€éŠ·å”®ã€ç”Ÿç”¢èƒ½åŠ›è¦åŠƒï¼Œæ”¯æ´æ›´å®Œæ•´çš„è£½é€ æ’ç¨‹èˆ‡æˆæœ¬åˆ†æã€‚`},
  {key:'erp', title:'ERP', subtitle:'ä¼æ¥­è³‡æºè¦åŠƒ', desc:`æ•´åˆä¼æ¥­å…§éƒ¨è³‡æºï¼ˆè²¡å‹™ã€äººè³‡ã€æ¡è³¼ã€ç”Ÿç”¢ã€éŠ·å”®ç­‰ï¼‰ï¼Œæä¾›è·¨éƒ¨é–€ä½œæ¥­æµç¨‹èˆ‡å ±è¡¨ã€‚`},
  {key:'scm', title:'SCM', subtitle:'ä¾›æ‡‰éˆç®¡ç†', desc:`é€£çµä¾›æ‡‰å•†èˆ‡é€šè·¯ï¼Œç®¡ç†æ¡è³¼è«‹æ±‚ã€å ±åƒ¹ã€è¨‚å–®ç¢ºèªã€ä»˜æ¬¾èˆ‡ç™¼ç¥¨ç­‰ï¼Œç¢ºä¿ç‰©æ–™èˆ‡é›¶çµ„ä»¶ä¾›æ‡‰é †æš¢ã€‚`},
  {key:'crm', title:'CRM', subtitle:'é¡§å®¢é—œä¿‚ç®¡ç†', desc:`ç®¡ç†é¡§å®¢äº’å‹•ã€åˆ†ç¾¤èˆ‡å¿ èª åº¦ï¼ˆä¾‹å¦‚ RFM åˆ†æï¼‰ï¼Œä»¥æé«˜é¡§å®¢çµ‚èº«åƒ¹å€¼ (LTV)ã€‚`},
  {key:'eerp', title:'EERP', subtitle:'æ“´å……å‹ ERP', desc:`EERP = SCM + ERP + CRMã€‚è·¨çµ„ç¹”æ•´åˆä¼æ¥­èˆ‡ä¾›æ‡‰éˆã€é¡§å®¢äº’å‹•ç­‰ç³»çµ±ä»¥å½¢æˆå®Œæ•´åƒ¹å€¼ç¶²è·¯ã€‚`},
];

const sampleData = {
  mrp: [
    {id:1,name:'CPU', desc:'ç¬¬3ä»£è™•ç†å™¨', qty:100, cost:2500},
    {id:2,name:'DRAM 8GB', desc:'è¨˜æ†¶é«”æ¨¡çµ„', qty:800, cost:400},
    {id:3,name:'SSD 256G', desc:'å›ºæ…‹ç¡¬ç¢Ÿ', qty:150, cost:900},
  ],
  mrpii:[
    {id:1,name:'ç”Ÿç”¢å·¥æ™‚', desc:'æ¯é€±å·¥æ™‚ä¼°ç®—', qty:120, cost:0},
    {id:2,name:'ç”Ÿç”¢äººå“¡', desc:'ç­åˆ¥äººæ•¸', qty:8, cost:0},
  ],
  erp:[
    {id:1,name:'æ‡‰æ”¶å¸³æ¬¾', desc:'æœˆæœ«æ‡‰æ”¶çµ±è¨ˆ', qty:1, cost:500000},
    {id:2,name:'äººäº‹æˆæœ¬', desc:'æœˆè–ªç¸½é¡', qty:1, cost:200000},
  ],
  scm:[
    {id:1,name:'ä¾›æ‡‰å•†A', desc:'ä¸»è¦é›»æºä¾›æ‡‰å•†', qty:1, cost:0},
    {id:2,name:'æ¡è³¼è¨‚å–®#1001', desc:'5æœˆæ¡è³¼', qty:200, cost:120000},
  ],
  crm:[
    {id:1,name:'VIP å®¢æˆ¶', desc:'å¹´åº¦æ¶ˆè²»å‰ä¸‰å', qty:1, cost:0},
    {id:2,name:'ä¿ƒéŠ·æ´»å‹•', desc:'æœƒå“¡å›é¥‹ä¿ƒéŠ·', qty:1, cost:30000},
  ],
  eerp:[
    {id:1,name:'è·¨çµ„ç¹”å°ˆæ¡ˆ', desc:'ä¾›æ‡‰éˆæ•´åˆè¨ˆç•«', qty:1, cost:0},
  ]
};

/* --- localStorage key --- */
const STORAGE_KEY = 'demo_system_data_v1';

/* --- App State --- */
let state = {
  current: 'mrp',
  data: {}
};

/* --- DOM references --- */
const menuEl = document.getElementById('menu');
const systemTitle = document.getElementById('systemTitle');
const systemSubtitle = document.getElementById('systemSubtitle');
const systemDesc = document.getElementById('systemDesc');
const listCount = document.getElementById('listCount');
const dataTbody = document.querySelector('#dataTable tbody');
const addBtn = document.getElementById('addBtn');
const resetBtn = document.getElementById('resetBtn');
const modalRoot = document.getElementById('modalRoot');
const modalTitle = document.getElementById('modalTitle');
const f_name = document.getElementById('f_name');
const f_qty = document.getElementById('f_qty');
const f_cost = document.getElementById('f_cost');
const f_desc = document.getElementById('f_desc');
const cancelModal = document.getElementById('cancelModal');
const saveModal = document.getElementById('saveModal');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

/* --- Chart --- */
let pieChart = null;
const pieCtx = document.getElementById('pieChart').getContext('2d');
const palette = ['#F6D6C2','#FBC7A4','#F5A882','#E07A5F','#C8553D','#F2E8CF'];

/* --- Functions --- */
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      state.data = JSON.parse(raw);
      // ensure keys exist
      systems.forEach(s => { if(!state.data[s.key]) state.data[s.key]=[]; });
      return;
    }catch(e){
      console.warn('è§£æ localStorage å¤±æ•—ï¼Œå°‡é‚„åŸç¯„ä¾‹è³‡æ–™');
    }
  }
  // æ²’æœ‰è³‡æ–™æˆ–è§£æéŒ¯èª¤ -> ä½¿ç”¨ç¯„ä¾‹
  state.data = JSON.parse(JSON.stringify(sampleData));
  saveData();
}

function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
  renderAll();
}

function resetToSample(){
  if(!confirm('ç¢ºå®šè¦é‚„åŸç‚ºç¯„ä¾‹è³‡æ–™ï¼Ÿå°‡æœƒè¦†è“‹ç›®å‰æœ¬æ©Ÿè³‡æ–™ã€‚')) return;
  state.data = JSON.parse(JSON.stringify(sampleData));
  saveData();
}

function renderMenu(){
  menuEl.innerHTML = '';
  systems.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'nav-item' + (state.current===s.key ? ' active' : '');
    div.innerHTML = `<div style="width:10px;height:10px;border-radius:50%;background:${palette[systems.indexOf(s)%palette.length]};"></div>
                     <div style="flex:1"><strong style="display:block">${s.title}</strong><span class="muted">${s.subtitle}</span></div>`;
    div.onclick = ()=>{ state.current = s.key; renderAll(); };
    menuEl.appendChild(div);
  });
}

function renderHeader(){
  const s = systems.find(x=>x.key===state.current);
  systemTitle.textContent = `${s.title} â€” ${s.subtitle}`;
  systemSubtitle.textContent = s.key;
  systemDesc.textContent = s.desc;
}

function renderTable(){
  const rows = state.data[state.current] || [];
  dataTbody.innerHTML = '';
  listCount.textContent = `ï¼ˆå…± ${rows.length} ç­†ï¼‰`;
  if(rows.length===0){
    dataTbody.innerHTML = `<tr><td colspan="5" class="muted">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹é»ã€Œæ–°å¢ç­†éŒ„ã€å»ºç«‹ã€‚</td></tr>`;
    return;
  }
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td>
                    <td>${escapeHtml(r.desc||'')}</td>
                    <td>${r.qty}</td>
                    <td>${formatCurrency(r.cost)}</td>
                    <td>
                      <button class="icon-btn" title="ç·¨è¼¯" onclick="openEdit(${r.id})">âœï¸</button>
                      <button class="icon-btn" title="åˆªé™¤" onclick="removeRow(${r.id})">ğŸ—‘ï¸</button>
                    </td>`;
    dataTbody.appendChild(tr);
  });
}

function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatCurrency(n){ if(!n && n!==0) return '-'; return 'NT$' + Number(n).toLocaleString(); }

function openAdd(){
  modalTitle.textContent = `æ–°å¢ç­†éŒ„ â€” ${state.current.toUpperCase()}`;
  f_name.value=''; f_qty.value='1'; f_cost.value='0'; f_desc.value='';
  modalRoot.style.display='flex';
  modalRoot.dataset.editId = '';
}
function openEdit(id){
  const rows = state.data[state.current];
  const item = rows.find(x=>x.id===id);
  if(!item) return alert('æ‰¾ä¸åˆ°è³‡æ–™');
  modalTitle.textContent = `ç·¨è¼¯ç­†éŒ„ â€” ${state.current.toUpperCase()}`;
  f_name.value = item.name; f_qty.value = item.qty; f_cost.value = item.cost; f_desc.value = item.desc||'';
  modalRoot.style.display='flex';
  modalRoot.dataset.editId = id;
}

function closeModal(){ modalRoot.style.display='none'; modalRoot.dataset.editId=''; }

function saveModalHandler(){
  const name = f_name.value.trim();
  const qty = Number(f_qty.value) || 0;
  const cost = Number(f_cost.value) || 0;
  const desc = f_desc.value.trim();
  if(!name) return alert('è«‹å¡«å¯«é …ç›®åç¨±');
  const rows = state.data[state.current];
  const editId = modalRoot.dataset.editId;
  if(editId){
    // update
    const idx = rows.findIndex(x=>x.id==Number(editId));
    if(idx>=0){
      rows[idx].name = name; rows[idx].qty = qty; rows[idx].cost = cost; rows[idx].desc = desc;
    }
  } else {
    // new id = max+1
    const maxId = rows.reduce((m,r)=>Math.max(m,r.id||0),0);
    rows.push({id:maxId+1, name, qty, cost, desc});
  }
  saveData();
  closeModal();
}

function removeRow(id){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;
  const rows = state.data[state.current];
  state.data[state.current] = rows.filter(x=>x.id!==id);
  saveData();
}

/* --- EXPORT / IMPORT --- */
function exportJson(){
  const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'system_data_export.json';
  a.click();
  URL.revokeObjectURL(url);
}
function importJson(){
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const parsed = JSON.parse(reader.result);
        // basic validation: must have keys for systems
        const keys = Object.keys(parsed);
        if(!systems.every(s=>keys.includes(s.key))) {
          if(!confirm('è¼‰å…¥çš„è³‡æ–™ä¸åŒ…å«æ‰€æœ‰ç³»çµ±ï¼Œæ˜¯å¦ä»ç„¶è¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Ÿ')) return;
        }
        state.data = parsed;
        saveData();
        alert('åŒ¯å…¥å®Œæˆ');
      }catch(err){
        alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
      }
    };
    reader.readAsText(f);
  };
  input.click();
}

/* --- Pie Chart --- */
function drawChart(){
  const counts = systems.map(s => (state.data[s.key] && state.data[s.key].length) || 0);
  const labels = systems.map(s=>s.title);
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, {
    type:'pie',
    data:{
      labels,
      datasets:[{
        data:counts,
        backgroundColor: palette,
        borderColor: '#fff',
        borderWidth:2
      }]
    },
    options:{
      plugins:{
        legend:{ position:'bottom', labels:{boxWidth:12, padding:12} }
      },
      maintainAspectRatio:false
    }
  });
}

/* --- render everything --- */
function renderAll(){
  renderMenu();
  renderHeader();
  renderTable();
  drawChart();
}

/* --- events --- */
addBtn.onclick = ()=> openAdd();
resetBtn.onclick = ()=> resetToSample();
cancelModal.onclick = ()=> closeModal();
saveModal.onclick = ()=> saveModalHandler();
exportBtn.onclick = ()=> exportJson();
importBtn.onclick = ()=> importJson();

/* allow modal close when clicking outside inner box */
modalRoot.addEventListener('click', (e)=>{
  if(e.target===modalRoot){ closeModal(); }
});

/* global helpers for inline onclick in rows */
window.openEdit = openEdit;
window.removeRow = removeRow;

/* init */
loadData();
renderAll();

</script>
</body>
</html>