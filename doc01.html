<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ–‡ä»¶ç®¡ç†ç³»çµ± â€” ç²¾ç¾æ·ºè‰²æš–è‰²ç‰ˆ</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fbf8f5;
    --panel:#ffffff;
    --muted:#7a6b61;
    --accent:#b65f2a;
    --accent-2: #e9cdbf;
    --accent-contrast: #fffaf7;
    --success: #2e8b57;
    --danger: #d9534f;
    --glass: rgba(255,255,255,0.6);
    --sidebar-width: 260px;
    --radius:12px;
    --shadow: 0 6px 18px rgba(21,18,15,0.06);
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: light;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:#2b2b2b}
  a{color:inherit;text-decoration:none}

  /* ====== NAVBAR ====== */
  .navbar{
    position:fixed;
    top:0;left:0;right:0;
    height:56px;
    background:linear-gradient(90deg,var(--accent),#f0b087);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 20px;
    font-weight:600;
    z-index:1000;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }
  .navbar .nav-left{display:flex;align-items:center;gap:12px}
  .navbar .nav-left .brand-name{font-size:16px}
  .navbar .nav-right{display:flex;align-items:center;gap:16px;font-size:14px}
  .navbar a{color:#fff;opacity:0.9}
  .navbar a:hover{opacity:1}

  /* layout */
  .app {
    display:flex;
    min-height:100vh;
    margin-top:56px; /* é¿é–‹ navbar */
  }

  /* sidebar */
  .sidebar{
    width:var(--sidebar-width);
    padding:28px 20px;
    background:linear-gradient(180deg,var(--panel),var(--accent-contrast));
    border-right:1px solid rgba(0,0,0,0.04);
    box-shadow: var(--shadow);
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  

  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo {
    width:54px;height:54px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent),#f0b087);
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;font-size:18px;
    box-shadow: 0 6px 18px rgba(182,95,42,0.18);
  }
  .brand h1{font-size:16px;margin:0}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  nav.menu{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  nav .menu-item{
    padding:10px 12px;border-radius:10px;display:flex;align-items:center;gap:10px;
    cursor:pointer;font-weight:600;color:var(--accent);
  }
  nav .menu-item:hover{background:var(--accent-2)}
  nav .menu-item.active{background:linear-gradient(90deg,var(--accent-2),rgba(255,255,255,0.6));box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}

  .sidebar .small{font-size:12px;color:var(--muted);margin-top:auto}

  /* main content */
  .main {
    flex:1;padding:24px;
  }
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
  }
  .topbar .search{
    flex:1;display:flex;gap:12px;align-items:center;
    background:var(--panel);padding:10px;border-radius:12px;box-shadow:var(--shadow);
  }
  .search input{flex:1;border:0;background:transparent;outline:none;font-size:14px}
  .actions{display:flex;gap:10px;align-items:center}

  /* card */
  .card{background:var(--panel);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow)}

  /* table */
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:left}
  th{font-size:12px;color:var(--muted);font-weight:600}
  td .chip{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
  .status-draft{background:#fff6e8;color:#b66d25}
  .status-review{background:#fff4f4;color:#c64a4a}
  .status-approved{background:#eef9f2;color:#1f8a52}

  /* buttons */
  .btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,0,0,0.06)}
  .btn.danger{background:var(--danger)}
  .btn.small{padding:6px 8px;font-size:13px}

  /* layout columns */
  .grid {display:grid;grid-template-columns:1fr 420px;gap:18px}
  .right-panel{display:flex;flex-direction:column;gap:12px}

  /* upload area */
  .upload-box{border:2px dashed rgba(0,0,0,0.05);padding:14px;border-radius:10px;text-align:center;background:linear-gradient(180deg,transparent,var(--accent-contrast))}
  input[type=file]{display:none}

  /* user list */
  .user-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px;border-radius:8px}
  .role {font-weight:600;font-size:13px;color:var(--muted)}

  /* responsive */
  @media (max-width:900px){
    .grid{grid-template-columns:1fr}
    .sidebar{display:none}
  }

  /* login overlay */
  .login-wrap{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(10,10,10,0.12), rgba(10,10,10,0.02));
  }
  .login{
    width:420px;background:var(--panel);padding:22px;border-radius:14px;box-shadow:0 18px 40px rgba(11,9,7,0.12)
  }
  .login h2{margin:0 0 8px}
  .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .field input, .field select{padding:10px;border-radius:9px;border:1px solid rgba(0,0,0,0.06);outline:none}
  .small-quiet{font-size:12px;color:var(--muted)}

  /* modal */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.32);display:flex;align-items:center;justify-content:center;
  }
  .modal{width:720px;background:var(--panel);padding:18px;border-radius:12px}
  .form-row{display:flex;gap:10px}
  .form-row > *{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .tiny{font-size:12px;color:var(--muted)}

  footer.small{margin-top:18px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <!-- ====== NAVBAR ====== -->
<header class="navbar">
  <div class="nav-left">
    <span class="brand-name">ğŸ“‚ æ–‡ä»¶ç®¡ç†ç³»çµ±</span>
  </div>
  <div class="nav-right">
    <a href="sys.html" data-view="sys">å›é¦–é ï¼ˆè³‡è¨Šç³»çµ±ï¼‰</a>
    <a href="resume.html" data-view="resume">å±¥æ­·</a>
    <a href="doc.html" data-view="doc">æ–‡ä»¶ç®¡ç†ç³»çµ±</a>
    <a href="doc02.html" data-view="doc02">æ–‡ä»¶ç®¡ç†ç³»çµ±2</a>
    <a href="index.html" data-view="index">å››å¤§ä¸»é¡Œç®¡ç†ç³»çµ±</a>
  </div>
</header>
<div id="app" class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">FM</div>
      <div>
        <h1>æª”æ¡ˆæ–‡ç®¡ç³»çµ±</h1>
        <p>æ–‡ä»¶ & æ¬Šé™ç®¡ç†å¹³å°</p>
      </div>
    </div>

    <nav class="menu" id="menu">
      <div class="menu-item active" data-view="dashboard">ğŸ“„ æ–‡ä»¶é¦–é </div>
      <div class="menu-item" data-view="upload">â¬†ï¸ ä¸Šå‚³æ–‡ä»¶</div>
      <div class="menu-item" data-view="users">ğŸ‘¥ äººå“¡ç®¡ç†</div>
      <div class="menu-item" data-view="settings">âš™ï¸ ç³»çµ±è¨­å®š</div>
      <div class="menu-item" data-view="about">â„¹ï¸ èªªæ˜</div>
    </nav>

    <div style="margin-top:8px">
      <button class="btn ghost" id="themeToggle">åˆ‡æ›ä¸»é¡Œ</button>
    </div>

    <div class="small">Â© æª”æ¡ˆç³»çµ±</div>
  </aside>

  <!-- Main area -->
  <main class="main">
    <div class="topbar">
      <div class="search card">
        <input id="searchInput" placeholder="æœå°‹æ–‡ä»¶åç¨±ã€ä¸Šå‚³äººæˆ–æ¨™ç±¤..." />
        <div class="actions">
          <button class="btn ghost" id="newDocBtn">æ–°å¢ç©ºç™½æª”</button>
          <button class="btn" id="logoutBtn">ç™»å‡º</button>
        </div>
      </div>
    </div>

    <div id="contentArea">
      <!-- Dashboard view -->
      <section id="dashboardView" class="grid">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h3 style="margin:0">æˆ‘çš„æ–‡ä»¶</h3>
                <div class="tiny">å¿«é€Ÿæª¢è¦–æœ€è¿‘ä¸Šå‚³èˆ‡ç‹€æ…‹</div>
              </div>
              <div class="muted tiny">å…± <span id="totalCount">0</span> ç­†æ–‡ä»¶</div>
            </div>

            <div style="margin-top:12px;overflow:auto">
              <table id="docTable">
                <thead>
                  <tr><th>æ–‡ä»¶åç¨±</th><th>ä¸Šå‚³è€…</th><th>æ›´æ–°æ™‚é–“</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card">
            <h4 style="margin:0 0 8px">æ´»å‹•ç´€éŒ„</h4>
            <div id="logList" class="tiny muted">ç›®å‰å°šç„¡æ´»å‹•</div>
          </div>
        </div>

        <aside class="right-panel">
          <div class="card">
            <h4 style="margin:0 0 8px">ä¸Šå‚³å¿«é€Ÿæ“ä½œ</h4>
            <label class="upload-box" for="fileInput" id="uploadZone">
              é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•ä¸Šå‚³<br><span class="tiny muted">æ”¯æ´ä»»æ„æª”æ¡ˆï¼ˆæ¨¡æ“¬ä¸Šå‚³ï¼‰</span>
              <input type="file" id="fileInput" />
            </label>
          </div>

          <div class="card">
            <h4 style="margin:0 0 8px">ç¯©é¸</h4>
            <div style="display:flex;gap:8px">
              <select id="filterStatus">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="draft">è‰ç¨¿</option>
                <option value="review">å¯©æ ¸ä¸­</option>
                <option value="approved">æ ¸å‡†</option>
              </select>
              <select id="filterOwner"></select>
            </div>
            <div style="margin-top:10px">
              <button class="btn ghost" id="clearFilters">æ¸…é™¤ç¯©é¸</button>
            </div>
          </div>

          <div class="card">
            <h4 style="margin:0 0 8px">ç³»çµ±æ‘˜è¦</h4>
            <div class="tiny muted">ä½¿ç”¨è€…ï¼š<span id="currentUserDisplay">æœªç™»å…¥</span></div>
            <div class="tiny muted">è§’è‰²ï¼š<span id="currentRoleDisplay">â€”</span></div>
            <footer class="small">ç³»çµ±ç‚ºå‰ç«¯ç¤ºç¯„ï¼Œè³‡æ–™ä¿å­˜åœ¨ç€è¦½å™¨ localStorageã€‚</footer>
          </div>
        </aside>
      </section>

      <!-- Upload view -->
      <section id="uploadView" style="display:none">
        <div class="card">
          <h3>ä¸Šå‚³æ–°æ–‡ä»¶</h3>
          <div class="field">
            <label>é¸æ“‡æª”æ¡ˆï¼ˆæ”¯æ´å¤šé¸ï¼‰</label>
            <input type="file" id="multiFileInput" multiple />
          </div>
          <div class="field">
            <label>æ¨™é¡Œ</label>
            <input id="uploadTitle" placeholder="æ–‡ä»¶æ¨™é¡Œï¼ˆè‹¥å¤šæª”å‰‡ç‚ºé è¨­æ¨™é¡Œï¼‰" />
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="doUpload">ä¸Šå‚³</button>
            <button class="btn ghost" id="backToDashboard">å›é¦–é </button>
          </div>
        </div>
      </section>

      <!-- Users Management -->
      <section id="usersView" style="display:none">
        <div class="card">
          <h3>äººå“¡ç®¡ç†</h3>
          <div class="tiny muted">åƒ…ç³»çµ±ç®¡ç†å“¡å¯ä»¥æ–°å¢/ç§»é™¤æˆ–è®Šæ›´æ¬Šé™ã€‚</div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <input id="newUserName" placeholder="å¸³è™Ÿï¼ˆä¾‹å¦‚: aliceï¼‰" />
            <select id="newUserRole">
              <option value="admin">Adminï¼ˆç®¡ç†å“¡ï¼‰</option>
              <option value="editor">Editorï¼ˆç·¨è¼¯ï¼‰</option>
              <option value="viewer">Viewerï¼ˆæª¢è¦–ï¼‰</option>
            </select>
            <button class="btn" id="addUserBtn">æ–°å¢äººå“¡</button>
          </div>

          <div style="margin-top:12px">
            <div id="userList"></div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsView" style="display:none">
        <div class="card">
          <h3>ç³»çµ±è¨­å®š</h3>
          <div class="field">
            <label>ç³»çµ±åç¨±</label>
            <input id="sysName" value="æª”æ¡ˆæ–‡ç®¡ç³»çµ±" />
          </div>
          <div style="margin-top:10px">
            <button class="btn" id="saveSys">ä¿å­˜</button>
          </div>
        </div>
      </section>

      <!-- About -->
      <section id="aboutView" style="display:none">
        <div class="card">
          <h3>é—œæ–¼</h3>
          <p class="muted tiny">
            é€™æ˜¯ä¸€å€‹å‰ç«¯æ¨¡æ“¬çš„æ–‡ä»¶ç®¡ç† UI ç¯„ä¾‹ã€‚åŠŸèƒ½ç¤ºç¯„ï¼šç™»å…¥/æ¬Šé™ã€æ–‡ä»¶ä¸Šå‚³ã€ç·¨è¼¯ç‹€æ…‹ã€ä½¿ç”¨è€…ç®¡ç†èˆ‡æª”æ¡ˆä¸‹è¼‰ã€‚å¯¦å‹™ä¸Šè«‹æ­é…å¾Œç«¯ API èˆ‡æª”æ¡ˆå„²å­˜æœå‹™ã€‚
          </p>
          <p class="tiny muted">è¨­è¨ˆï¼šæ·ºè‰²æš–è‰²ç³»ï¼Œç°¡æ½”ã€å°ˆæ¥­ã€å‹å¥½ã€‚</p>
        </div>
      </section>
    </div>

  </main>
</div>

<!-- Login Overlay -->
<div id="loginOverlay" class="login-wrap">
  <div class="login card">
    <h2>ç™»å…¥ ç³»çµ±</h2>
    <div class="field">
      <label>å¸³è™Ÿ</label>
      <input id="loginUser" placeholder="è¼¸å…¥å¸³è™Ÿï¼ˆä¾‹å¦‚ adminï¼‰" />
    </div>
    <div class="field">
      <label>å¯†ç¢¼</label>
      <input id="loginPass" type="password" placeholder="ä»»æ„æ¸¬è©¦å¯†ç¢¼" />
    </div>
    <div class="field" style="flex-direction:row;align-items:center;gap:8px;margin-top:12px">
      <button class="btn" id="loginBtn">ç™»å…¥</button>
      <div style="margin-left:auto" class="small-quiet">æ¸¬è©¦å¸³è™Ÿï¼šadmin/editor/viewerï¼ˆå¯†ç¢¼ä»»æ„ï¼‰</div>
    </div>
    <div style="margin-top:10px" class="tiny muted">ç™»å…¥å¾Œç³»çµ±æœƒæ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒæ¬Šé™ã€‚</div>
  </div>
</div>

<!-- Modal: Edit Document -->
<div id="editModal" style="display:none">
  <div class="modal-backdrop">
    <div class="modal">
      <h3 id="editModalTitle">ç·¨è¼¯æ–‡ä»¶</h3>
      <div class="form-row" style="margin-top:8px">
        <input id="editTitle" />
        <select id="editStatus">
          <option value="draft">è‰ç¨¿</option>
          <option value="review">å¯©æ ¸ä¸­</option>
          <option value="approved">æ ¸å‡†</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <label class="tiny muted">ä¸Šå‚³è€…</label>
        <div id="editOwner" class="muted tiny"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="cancelEdit">å–æ¶ˆ</button>
        <button class="btn" id="saveEdit">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>
</div>

<script>
/* --- åˆå§‹è³‡æ–™ï¼šè‹¥ localStorage ç„¡è³‡æ–™å‰‡æ³¨å…¥ç¯„ä¾‹ä½¿ç”¨è€…èˆ‡æ–‡ä»¶ --- */
const DB_KEYS = { USERS: 'dm_users_v1', DOCS:'dm_docs_v1', LOGS:'dm_logs_v1', SYS:'dm_sys_v1' };

function nowISO(){ return new Date().toISOString(); }

function seedIfEmpty(){
  if(!localStorage.getItem(DB_KEYS.USERS)){
    const users = [
      {id: 'admin', role:'admin', name:'ç³»çµ±ç®¡ç†è€…'},
      {id: 'editor', role:'editor', name:'ç·¨è¼¯äººå“¡'},
      {id: 'viewer', role:'viewer', name:'æª¢è¦–è€…'}
    ];
    localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
  }
  if(!localStorage.getItem(DB_KEYS.DOCS)){
    const docs = [
      {id: genId(), title:'å…¬å¸æ”¿ç­–æ‰‹å†Š.pdf', owner:'admin', status:'approved', updated: nowISO(), size: '82KB', contentType:'application/pdf', dataBase64: '', note:'ç¯„ä¾‹æª”ï¼ˆæœªå«å¯¦éš›äºŒé€²ä½ï¼‰'},
      {id: genId(), title:'ç³»çµ±éœ€æ±‚èªªæ˜.docx', owner:'editor', status:'review', updated: nowISO(), size:'54KB', contentType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document', dataBase64:'', note:''},
      {id: genId(), title:'å°ˆæ¡ˆé€²åº¦_2025.xlsx', owner:'editor', status:'draft', updated: nowISO(), size:'24KB', contentType:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', dataBase64:'', note:''}
    ];
    localStorage.setItem(DB_KEYS.DOCS, JSON.stringify(docs));
  }
  if(!localStorage.getItem(DB_KEYS.LOGS)){
    localStorage.setItem(DB_KEYS.LOGS, JSON.stringify([]));
  }
  if(!localStorage.getItem(DB_KEYS.SYS)){
    localStorage.setItem(DB_KEYS.SYS, JSON.stringify({name:'æ˜æ…§æ–‡ç®¡ç³»çµ±', theme:'warm'}));
  }
}

function genId(){ return 'd_' + Math.random().toString(36).slice(2,10); }
seedIfEmpty();

/* --- app state --- */
let state = {
  currentUser: null,
  currentView: 'dashboard',
  editDocId: null
};

/* --- helpers to read/write db --- */
function read(key){ return JSON.parse(localStorage.getItem(key) || 'null'); }
function write(key,v){ localStorage.setItem(key, JSON.stringify(v)); }
function logAction(text){
  const logs = read(DB_KEYS.LOGS) || [];
  logs.unshift({t: nowISO(), text});
  write(DB_KEYS.LOGS, logs.slice(0,50));
  renderLogs();
}

/* --- UI binding --- */
const loginOverlay = document.getElementById('loginOverlay');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const currentUserDisplay = document.getElementById('currentUserDisplay');
const currentRoleDisplay = document.getElementById('currentRoleDisplay');
const menuItems = document.querySelectorAll('.menu-item');
const views = { dashboard: document.getElementById('dashboardView'), upload: document.getElementById('uploadView'), users: document.getElementById('usersView'), settings: document.getElementById('settingsView'), about: document.getElementById('aboutView') };
const docTableBody = document.querySelector('#docTable tbody');
const totalCount = document.getElementById('totalCount');
const fileInput = document.getElementById('fileInput');
const multiFileInput = document.getElementById('multiFileInput');
const uploadZone = document.getElementById('uploadZone');
const filterStatus = document.getElementById('filterStatus');
const filterOwner = document.getElementById('filterOwner');
const clearFilters = document.getElementById('clearFilters');
const searchInput = document.getElementById('searchInput');
const newDocBtn = document.getElementById('newDocBtn');
const themeToggle = document.getElementById('themeToggle');
const editModal = document.getElementById('editModal');
const editTitle = document.getElementById('editTitle');
const editStatus = document.getElementById('editStatus');
const editOwner = document.getElementById('editOwner');
const saveEdit = document.getElementById('saveEdit');
const cancelEdit = document.getElementById('cancelEdit');
const userListEl = document.getElementById('userList');
const addUserBtn = document.getElementById('addUserBtn');
const newUserName = document.getElementById('newUserName');
const newUserRole = document.getElementById('newUserRole');
const filterOwnerSelect = filterOwner;
const logList = document.getElementById('logList');
const newDocBtnTop = document.getElementById('newDocBtn');
const multiUploadBtn = document.getElementById('doUpload');

const sysName = document.getElementById('sysName');
const saveSys = document.getElementById('saveSys');
const backToDashboard = document.getElementById('backToDashboard');
const totalCountLabel = totalCount;

/* --- navigation --- */
menuItems.forEach(mi => mi.addEventListener('click', ()=> {
  menuItems.forEach(m=>m.classList.remove('active'));
  mi.classList.add('active');
  showView(mi.dataset.view);
}));

function showView(name){
  state.currentView = name;
  Object.keys(views).forEach(k=>{
    views[k].style.display = (k===name) ? '' : 'none';
  });
}

/* --- theme toggle --- */
function applyTheme(){
  const sys = read(DB_KEYS.SYS) || {};
  if(sys.theme === 'neutral') document.documentElement.classList.add('theme-neutral');
  else document.documentElement.classList.remove('theme-neutral');
}
themeToggle.addEventListener('click', ()=>{
  const sys = read(DB_KEYS.SYS) || {};
  sys.theme = (sys.theme === 'neutral') ? 'warm' : 'neutral';
  write(DB_KEYS.SYS, sys);
  applyTheme();
});

/* --- login/logout --- */
loginBtn.addEventListener('click', ()=>{
  const u = loginUser.value.trim();
  if(!u){ alert('è«‹è¼¸å…¥å¸³è™Ÿ'); return; }
  const users = read(DB_KEYS.USERS) || [];
  let found = users.find(x=>x.id===u);
  // è‹¥ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹ viewerï¼ˆæ¨¡æ“¬ï¼‰
  if(!found){
    found = {id:u, role:'viewer', name:u};
    users.push(found);
    write(DB_KEYS.USERS, users);
  }
  state.currentUser = found;
  loginOverlay.style.display = 'none';
  currentUserDisplay.textContent = found.name + ' ('+found.id+')';
  currentRoleDisplay.textContent = found.role;
  logAction(`ä½¿ç”¨è€… ${found.id} ç™»å…¥`);
  renderAll();
});

logoutBtn.addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
  logAction(`ä½¿ç”¨è€… ${state.currentUser?.id || 'è¨ªå®¢'} ç™»å‡º`);
  state.currentUser = null;
  loginOverlay.style.display = '';
  currentUserDisplay.textContent = 'æœªç™»å…¥';
  currentRoleDisplay.textContent = 'â€”';
});

/* --- render documents table --- */
function getDocs(){
  const docs = read(DB_KEYS.DOCS) || [];
  return docs;
}
function renderDocs(){
  const docs = getDocs();
  const q = (searchInput.value || '').toLowerCase();
  const statusFilter = filterStatus.value;
  const ownerFilter = filterOwner.value;

  const filtered = docs.filter(d=>{
    if(statusFilter && d.status !== statusFilter) return false;
    if(ownerFilter && d.owner !== ownerFilter) return false;
    if(!q) return true;
    return (d.title||'').toLowerCase().includes(q) || (d.owner||'').toLowerCase().includes(q) || (d.note||'').toLowerCase().includes(q);
  });

  docTableBody.innerHTML = '';
  filtered.forEach(d=>{
    const tr = document.createElement('tr');
    const titleTd = document.createElement('td');
    titleTd.innerHTML = `<div style="font-weight:600">${escapeHtml(d.title)}</div><div class="tiny muted">${d.size} â€¢ ${d.contentType || 'â€”'}</div>`;
    const ownerTd = document.createElement('td'); ownerTd.textContent = d.owner;
    const updatedTd = document.createElement('td'); updatedTd.textContent = new Date(d.updated).toLocaleString();
    const statusTd = document.createElement('td');
    let statusLabel = '';
    if(d.status==='draft') statusLabel = `<span class="chip status-draft">è‰ç¨¿</span>`;
    if(d.status==='review') statusLabel = `<span class="chip status-review">å¯©æ ¸ä¸­</span>`;
    if(d.status==='approved') statusLabel = `<span class="chip status-approved">æ ¸å‡†</span>`;
    statusTd.innerHTML = statusLabel;

    const actionsTd = document.createElement('td');
    // buttons visible by role
    const role = state.currentUser?.role || 'viewer';
    // download always available
    const downBtn = document.createElement('button'); downBtn.className='btn small ghost'; downBtn.textContent='ä¸‹è¼‰'; downBtn.onclick = ()=>downloadDoc(d.id);
    actionsTd.appendChild(downBtn);
    if(role === 'admin' || role === 'editor'){
      const editBtn = document.createElement('button'); editBtn.className='btn small'; editBtn.textContent='ç·¨è¼¯'; editBtn.onclick = ()=>openEdit(d.id);
      actionsTd.appendChild(editBtn);
    }
    if(role === 'admin'){
      const delBtn = document.createElement('button'); delBtn.className='btn small danger'; delBtn.textContent='åˆªé™¤'; delBtn.onclick = ()=>deleteDoc(d.id);
      actionsTd.appendChild(delBtn);
    }
    tr.appendChild(titleTd);
    tr.appendChild(ownerTd);
    tr.appendChild(updatedTd);
    tr.appendChild(statusTd);
    tr.appendChild(actionsTd);
    docTableBody.appendChild(tr);
  });

  totalCount.textContent = filtered.length;
}

/* escape */
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

/* download document (reconstruct from base64 if present, otherwise create placeholder) */
function downloadDoc(id){
  const docs = getDocs();
  const d = docs.find(x=>x.id===id);
  if(!d) return alert('æ‰¾ä¸åˆ°æ–‡ä»¶');
  logAction(`ä¸‹è¼‰ ${d.title} (by ${state.currentUser?.id||'guest'})`);
  // if dataBase64 available, convert
  if(d.dataBase64){
    const blob = base64ToBlob(d.dataBase64, d.contentType || 'application/octet-stream');
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = d.title || 'download.bin'; document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  } else {
    // create simple text file placeholder
    const contents = `æª”å: ${d.title}\nä¸Šå‚³è€…: ${d.owner}\nå»ºç«‹æ™‚é–“: ${d.updated}\nç‹€æ…‹: ${d.status}\n\nï¼ˆæ­¤ç‚ºå‰ç«¯ç¤ºç¯„æª”ï¼Œå¯¦éš›æª”æ¡ˆå…§å®¹å°šæœªä¸Šå‚³ï¼‰`;
    const blob = new Blob([contents], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = d.title || 'placeholder.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
}

/* base64 to blob */
function base64ToBlob(base64, mime){
  const binStr = atob(base64.split(',').pop());
  const len = binStr.length;
  const arr = new Uint8Array(len);
  for(let i=0;i<len;i++) arr[i]=binStr.charCodeAt(i);
  return new Blob([arr], {type:mime});
}

/* open edit modal */
function openEdit(id){
  state.editDocId = id;
  const docs = getDocs();
  const d = docs.find(x=>x.id===id);
  if(!d) return;
  editTitle.value = d.title;
  editStatus.value = d.status;
  editOwner.textContent = d.owner;
  editModal.style.display = '';
}

/* save edit */
saveEdit.addEventListener('click', ()=>{
  const docs = getDocs();
  const d = docs.find(x=>x.id===state.editDocId);
  if(!d) return;
  d.title = editTitle.value || d.title;
  d.status = editStatus.value;
  d.updated = nowISO();
  write(DB_KEYS.DOCS, docs);
  editModal.style.display = 'none';
  logAction(`æ–‡ä»¶ ${d.title} å·²æ›´æ–°ï¼ˆ${state.currentUser?.id || 'unknown'}ï¼‰`);
  renderDocs();
});
cancelEdit.addEventListener('click', ()=>{ editModal.style.display = 'none'; });

/* delete */
function deleteDoc(id){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–‡ä»¶ï¼Ÿ')) return;
  const docs = getDocs();
  const idx = docs.findIndex(x=>x.id===id);
  if(idx===-1) return;
  const removed = docs.splice(idx,1)[0];
  write(DB_KEYS.DOCS, docs);
  logAction(`æ–‡ä»¶ ${removed.title} è¢«åˆªé™¤ï¼ˆ${state.currentUser?.id}ï¼‰`);
  renderDocs();
}

/* upload handling (single file input on sidebar) */
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if(!f) return;
  await processFileUpload(f);
  e.target.value='';
});

/* multi upload */
multiFileInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files);
  const title = document.getElementById('uploadTitle').value || '';
  for(const f of files){
    await processFileUpload(f, title);
  }
  e.target.value='';
});

/* drag and drop */
uploadZone.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadZone.style.opacity=0.9; });
uploadZone.addEventListener('dragleave', ()=>{ uploadZone.style.opacity=1; });
uploadZone.addEventListener('drop', async (e)=>{ e.preventDefault(); uploadZone.style.opacity=1;
  const files = Array.from(e.dataTransfer.files || []);
  for(const f of files) await processFileUpload(f);
});

/* process file: read base64 and store */
async function processFileUpload(file, titleFallback=''){
  if(!state.currentUser) return alert('è«‹å…ˆç™»å…¥');
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = ()=>{
    const base64 = reader.result;
    const docs = getDocs();
    const doc = {
      id: genId(),
      title: titleFallback || file.name,
      owner: state.currentUser.id,
      status:'draft',
      updated: nowISO(),
      size: Math.round(file.size/1024) + 'KB',
      contentType: file.type || 'application/octet-stream',
      dataBase64: base64,
      note:'ä¸Šå‚³æª”æ¡ˆ'
    };
    docs.unshift(doc);
    write(DB_KEYS.DOCS, docs);
    logAction(`ä¸Šå‚³æª”æ¡ˆ ${doc.title}ï¼ˆ${state.currentUser.id}ï¼‰`);
    renderDocs();
  };
}

/* new blank doc */
newDocBtnTop.addEventListener('click', ()=>{
  if(!state.currentUser) return alert('è«‹å…ˆç™»å…¥');
  const docs = getDocs();
  const d = { id: genId(), title:`æ–°å»ºæ–‡ä»¶_${new Date().toLocaleString()}`, owner: state.currentUser.id, status:'draft', updated: nowISO(), size:'0KB', contentType:'text/plain', dataBase64: btoa(''), note:'ç©ºç™½æ–‡ä»¶' };
  docs.unshift(d); write(DB_KEYS.DOCS, docs);
  logAction(`å»ºç«‹ç©ºç™½æ–‡ä»¶ ${d.title}ï¼ˆ${state.currentUser.id}ï¼‰`);
  renderDocs();
});

/* search / filters */
searchInput.addEventListener('input', ()=> renderDocs());
filterStatus.addEventListener('change', ()=> renderDocs());
filterOwner.addEventListener('change', ()=> renderDocs());
clearFilters.addEventListener('click', ()=>{ filterStatus.value=''; filterOwner.value=''; renderDocs(); });

/* render users */
function renderUsers(){
  const users = read(DB_KEYS.USERS) || [];
  userListEl.innerHTML = '';
  users.forEach(u=>{
    const div = document.createElement('div');
    div.className='user-row';
    div.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
      <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#f0b087);color:white;display:flex;align-items:center;justify-content:center;font-weight:700">${u.id[0].toUpperCase()}</div>
      <div>
        <div style="font-weight:700">${u.name} <span style="font-size:12px;color:var(--muted)">(${u.id})</span></div>
        <div class="muted tiny">è§’è‰²: <span class="role">${u.role}</span></div>
      </div>
    </div>`;
    const controls = document.createElement('div');
    if(state.currentUser?.role === 'admin'){
      const roleSel = document.createElement('select');
      ['admin','editor','viewer'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(u.role===r) o.selected=true; roleSel.appendChild(o); });
      roleSel.addEventListener('change', ()=>{ u.role = roleSel.value; write(DB_KEYS.USERS, users); logAction(`ä½¿ç”¨è€… ${u.id} è§’è‰²è®Šæ›´ç‚º ${u.role}`); renderUsers(); renderDocs(); });
      const del = document.createElement('button'); del.className='btn small danger'; del.textContent='ç§»é™¤'; del.onclick = ()=>{ if(!confirm('ç¢ºå®šç§»é™¤æ­¤äººå“¡ï¼Ÿ')) return; const arr = users.filter(x=>x.id!==u.id); write(DB_KEYS.USERS, arr); logAction(`ä½¿ç”¨è€… ${u.id} è¢«ç§»é™¤`); renderUsers(); };
      controls.appendChild(roleSel); controls.appendChild(del);
    } else {
      controls.innerHTML = `<div class="tiny muted">ç„¡æ¬Šé™è®Šæ›´</div>`;
    }
    div.appendChild(controls);
    userListEl.appendChild(div);
  });
}

/* add user */
addUserBtn.addEventListener('click', ()=>{
  if(!state.currentUser || state.currentUser.role !== 'admin'){ return alert('åƒ…ç®¡ç†å“¡å¯æ–°å¢ä½¿ç”¨è€…'); }
  const id = (newUserName.value||'').trim();
  const role = newUserRole.value;
  if(!id) return alert('è«‹è¼¸å…¥å¸³è™Ÿ');
  const users = read(DB_KEYS.USERS) || [];
  if(users.find(x=>x.id===id)) return alert('å¸³è™Ÿå·²å­˜åœ¨');
  users.push({id, role, name:id});
  write(DB_KEYS.USERS, users);
  logAction(`æ–°å¢ä½¿ç”¨è€… ${id}ï¼ˆ${role}ï¼‰`);
  newUserName.value=''; renderUsers(); populateFilterOwner();
});

/* populate owner filter */
function populateFilterOwner(){
  const users = read(DB_KEYS.USERS) || [];
  filterOwner.innerHTML = '<option value="">æ‰€æœ‰äºº</option>';
  users.forEach(u => {
    const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name + ' ('+u.id+')'; filterOwner.appendChild(opt);
  });
}

/* logs */
function renderLogs(){
  const logs = read(DB_KEYS.LOGS) || [];
  if(!logs.length) return logList.textContent = 'ç›®å‰å°šç„¡æ´»å‹•';
  logList.innerHTML = logs.slice(0,8).map(l=>`<div style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.04)">${new Date(l.t).toLocaleString()} â€” <span class="muted">${escapeHtml(l.text)}</span></div>`).join('');
}

/* settings save */
saveSys.addEventListener('click', ()=>{
  const s = read(DB_KEYS.SYS) || {};
  s.name = sysName.value || s.name;
  write(DB_KEYS.SYS,s);
  alert('å·²å„²å­˜è¨­å®š');
});

/* initial render */
function renderAll(){
  applyTheme();
  populateFilterOwner();
  renderUsers();
  renderDocs();
  renderLogs();
  const s = read(DB_KEYS.SYS) || {};
  sysName.value = s.name || sysName.value;
  // show current user display
  currentUserDisplay.textContent = state.currentUser ? (state.currentUser.name + ' ('+state.currentUser.id+')') : 'æœªç™»å…¥';
  currentRoleDisplay.textContent = state.currentUser ? state.currentUser.role : 'â€”';
}

/* quick back to dashboard */
backToDashboard.addEventListener('click', ()=> { showView('dashboard'); menuItems.forEach(m=>m.classList.remove('active')); document.querySelector('.menu-item[data-view="dashboard"]').classList.add('active'); });

/* delete doc via keyboard? Not necessary */

/* simple utility: convert DataURL to base64 string without prefix if needed (we store full dataUrl) */

/* initial */
renderAll();

/* quick UX: if already logged in from previous session, restore first user as logged in (optional) */
(function restoreIfSingle(){
  // no auto-login to respect security; user must login manually
})();

/* helper: small demo logs */
if((read(DB_KEYS.LOGS)||[]).length===0){
  logAction('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
}

/* allow downloading placeholder when doc has no data */
function ensureDocData(doc){
  if(!doc.dataBase64) doc.dataBase64 = '';
}

/* small escape for content */
function safe(s){ return s || ''; }

/* expose some global for debugging (optional) */
window.__DM = { read, write, getDocs, logAction };

/* render at intervals (for simplicity) */
setInterval(()=>{ renderDocs(); renderUsers(); renderLogs(); }, 3500);

</script>
</body>
</html>
